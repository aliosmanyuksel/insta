{% extends 'base.html.twig' %}

{% block body %}
    <script>
        $( document ).ready(function(){
            $('#mainTab').click(function (e) {
                e.preventDefault()
                $(this).tab('show')
            })
            $(function () {
                $('[data-toggle="popover"]').popover()
            })
            $('.wrapper').css('min-height',$(window).height())

            setInterval(function(){
                $.ajax({
                    method: "POST",
                    url: "{{ path('tasks_status') }}"
                })
                .done(function( msg ) {
                    for (var k in msg){
                        if (msg.hasOwnProperty(k)) {
                            var text = msg[k]['done'] + '/' + msg[k]['shouldbedone'];
                            var proc = msg[k]['done']/msg[k]['shouldbedone']*100 + '%';
                            $('#prgrs0'+msg[k]['id']).text(text);
                            $('#prgrs1'+msg[k]['id']).text(text);
                            $('#prgrs0'+msg[k]['id']).css('width', proc);
                            $('#prgrs1'+msg[k]['id']).css('width', proc);
                            $('#prgrs01').parent().prop('title',text)
                            if(msg[k]['status']==1){
                                $('#prgrs0'+msg[k]['id']).addClass('progress-bar-success');
                                $('#prgrs1'+msg[k]['id']).addClass('progress-bar-success');
                                $('#status'+msg[k]['id']).text('Завершено');
                            }
                            else if(msg[k]['status']==4 || msg[k]['status']==3 ){
                                $('#prgrs0'+msg[k]['id']).addClass('progress-bar-danger');
                                $('#prgrs1'+msg[k]['id']).addClass('progress-bar-danger');
                                if(msg[k]['status']==3)
                                    $('#status'+msg[k]['id']).text('Прервана');
                                else
                                    $('#status'+msg[k]['id']).text('Ошибка');
                            }
                        }
                    }
                });

            }, 5000);

            /*comments*/
            var showChar = 100;
            var ellipsestext = "...";
            var moretext = "+++";
            var lesstext = "---";
            $('.more').each(function() {
                var content = $(this).html();

                if(content.length > showChar) {

                    var c = content.substr(0, showChar);
                    var h = content.substr(showChar-1, content.length - showChar);

                    var html = c + '<span class="moreellipses">' + ellipsestext+ ' </span><span class="morecontent"><span>' + h + '</span>  <a href="" class="morelink">' + moretext + '</a></span>';

                    $(this).html(html);
                }

            });

            $(".morelink").click(function(){
                if($(this).hasClass("less")) {
                    $(this).removeClass("less");
                    $(this).html(moretext);
                } else {
                    $(this).addClass("less");
                    $(this).html(lesstext);
                }
                $(this).parent().prev().toggle();
                $(this).prev().toggle();
                return false;
            });
        })
    </script>

    <div class="row">
        <div class="col-xs-8">
            <h3>Немного советов</h3>
            <ul>
                <li>Для добавления нового аккаунта сначала необходимо нажать "Выйти из Instagram", а затем "Добавить аккаунт"</li>
                <li>Перед раскруткой аккаунта обязательно заполните его контентом</li>
                <li>Раскрутка ведется на нашем сервере, так что можете закрыть вкладку/выключить компьютер после создания задачи</li>
                <li>Раскрутка по тэгам и отписка начинается не сразу, а приблизительно через 10 минут после создания задания</li>
            </ul>
            <h3>Ограничения</h3>
            <ul>
                <li>На данный момент можно добавить не более 2х аккаунтов инстаграм</li>
                <li>Не более 500 итераций для одного задания</li>
                <li>Промежутки между лайкингом/фоловингом/отпиской сейчас фиксированные (20с - 40с)</li>
            </ul>
            <h3>Важно знать</h3>
            <ul>
                <li>Наша цель - освободить Вас от забот связанный с поиском прокси и выделенных серверов</li>
                <li>Сервис активно развивается и нуждается в Вашей <a href="{{ path('purchase') }}">поддержке</a></li>
                <li>Направление движения сервиса зависит от Вас <br/>Предложения и замечания пишите в <a href="https://vk.com/instastellar">группу в контакте</a></li>

            </ul>
        <a href ="{{ path('add_login_password_account') }}" type="button" class="btn btn-success">Добавить аккаунт</a>
        </div>
    </div>

<div class="panel-group" id="accordion">
    {% for account in accounts %}
        <div class="panel panel-default">
          <div class="panel-heading">

                <h4 class="panel-title" style="display: inline-block">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse{{ account.id }}" class="collapsed">
                        {% if account.picture %}
                            <img src="{{ account.picture }}" style="width: 24px;height: 24px;">
                        {% endif %}
                        {% if account.username %}
                            {{ account.username }}<br/>
                        {% endif %}

                    </a>
                </h4>

                <div class="btn-group pull-right">
                    <a href="{{ path("add_tasks", {'id' :account.id, 'type' : 0 })}}" type="button" class="btn btn-default" title="Добавление задачи по ID"><span class="glyphicon glyphicon-asterisk"></span></a>
                    <a href="{{ path("followByList", {'id' :account.id })}}" type="button" class="btn btn-default" title="Добавление задачи по списку"><span class="glyphicon glyphicon-asterisk"></span></a>
                    <a href="{{ path("add_tasks", {'id' :account.id, 'type' : 10})}}" type="button" class="btn btn-default" title="Добавление задачи по тэгам"><span class="glyphicon glyphicon-plus"></span></a>
                    <a href="{{ path('add_tasks', {'id': account.id, 'type' : 11 }) }}" type="button" class="btn btn-default" title="Лайкинг по тэгам"><span class="glyphicon glyphicon-heart"></span></a>
                    <a href="{{ path('unfollow',  {'id': account.id }) }}" type="button" class="btn btn-default" title="Отписка"><span class="glyphicon glyphicon-minus"></span></a>
                    <a href="{{ path('add_account') }}" type="button" class="btn btn-default"><span class="glyphicon glyphicon-repeat" title="Обновление токена"></span></a>
                    {% if account.tasks | length > 0 %}
                         {% if ((account.tasks | last).status in [2,0]) %}
                            <a href="{{ path('stop_tasks',{'id': (account.tasks | last).id })}}" type="button" class="btn btn-default" title="Остановка задачи"><span class="glyphicon glyphicon-stop"></span></a>
                         {% else %}
                             <a disabled type="button" class="btn btn-default" title="Остановка задачи"><span class="glyphicon glyphicon-stop"></span></a>
                         {% endif %}
                    {% else %}
                        <a disabled type="button" class="btn btn-default" title="Остановка задачи"><span class="glyphicon glyphicon-stop"></span></a>
                    {% endif %}
                    <!--<button type="button" class="btn btn-default"><span class="glyphicon glyphicon-trash"></span></button>-->

                </div>

              {% if account.tasks | length >0 %}
                  {%  set task = ''  %}
                  {% if (account.tasks | last).status == 1 %}
                      {%  set task = 'progress-bar-success'  %}
                  {% elseif (account.tasks | last).status in [3,4] %}
                      {%  set task = 'progress-bar-danger'  %}
                  {% endif %}
                  <div class="row">
                      <div class="col-xs-12">
                          <div class="progress" style="margin-bottom: 0px; height: 4px" title="{{ ((account.tasks | last).actions | length)}}/{{ ((account.tasks | last).count) }}">

                              <div class="progress-bar {{ task }}" id="prgrs0{{ account.id }}" role="progressbar" style="width:{{ ((account.tasks | last).actions | length) / ((account.tasks | last).count) * 100}}%">
                              </div>
                          </div>
                      </div>
                  </div>
              {% endif %}
            </div>

            <div  id="collapse{{ account.id }}" class="panel-collapse collapse" style="width: 100%;">
                <div class="panel-body">

                    <ul class="nav nav-tabs" id="mainTab">
                        <li class="active"><a href="#last{{ account.id }}" data-toggle="tab">Последнее задание</a></li>
                        <li><a href="#history{{ account.id }}" data-toggle="tab">История</a></li>
                    </ul>

                    <div class="tab-content">

                        <div class="tab-pane active" id="last{{ account.id }}">
                            {% if account.tasks | length >0  %}

                                <div class="row">
                                    <div class="col-xs-1"></div>
                                    <div class="col-xs-4">
                                        <h3><span class="glyphicon glyphicon-flag"></span>  Статус:</h3>
                                        <p id="status{{ account.id }}">
                                        {% if (account.tasks | last).status == 1 %}
                                            Завершено
                                        {% elseif (account.tasks | last).status == 2 %}
                                            Выполняется
                                        {% elseif (account.tasks | last).status == 3 %}
                                            Прервана
                                        {% elseif (account.tasks | last).status == 4 %}
                                            Ошибка
                                        {% elseif (account.tasks | last).status == 0 %}
                                            До начала задачи ~{{ ("now"|date_modify("+10 minutes")|date("U") - (account.tasks | last).createdAt|date('U')) |date('i:s') }}
                                        {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-xs-4">
                                        <h3><span class="glyphicon glyphicon-file"></span>  Тип задания:</h3>
                                        {% if (account.tasks | last).type == 0 %}
                                            <p>Подписка по ID</p>
                                        {% elseif (account.tasks | last).type == 10 %}
                                            <p>Подписка по тэгам</p>
                                        {% elseif (account.tasks | last).type == 20 %}
                                            <p>Подписка по списку</p>
                                        {% elseif (account.tasks | last).type == 11 %}
                                            <p>Лайкинг по тэгам</p>
                                        {% elseif (account.tasks | last).type == 3 %}
                                            <p>Отписка</p>
                                        {% endif %}
                                    </div>

                            </div>

                                <div class="row">
                                <div class="col-xs-1"></div>
                                <div class="col-xs-4">
                                    <h3><span class="glyphicon glyphicon-time"></span> Задание началось в:</h3>
                                    <p>{{ (account.tasks | last).createdAt | date("H:i d/m/Y", user.timezone) }} {{ user.timezone }}</p> {#date("h:i d/m/Y")#}
                                </div>
                                <div class="col-xs-4 long_tags">
                                    {% if (account.tasks | last).type in [0 ,1] %}
                                        <h3><span class="glyphicon glyphicon-link"></span> ID конкурента:</h3>
                                        <p>{{ (account.tasks | last).tags  }}</p>
                                    {% elseif (account.tasks | last).type in [10,11] %}
                                        <h3><span class="glyphicon glyphicon-link"></span> Тэги:</h3>
                                        <div class="comment more">{{ (account.tasks | last).tags  }}</div>
                                    {% endif %}
                                </div>
                            </div>

                                <div class="row">
                                <div class="col-xs-1"></div>
                                <div class="col-xs-10">
                                    <h3>Прогресс:</h3>
                                    <div class="progress">
                                        <div class="progress-bar {{ task }}" id="prgrs1{{ account.id }}" role="progressbar" style="width: {{ ((account.tasks | last).actions | length) / ((account.tasks | last).count) * 100}}%">
                                            {{ ((account.tasks | last).actions | length)}}/{{ ((account.tasks | last).count) }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <div class="row">
                                <div class="col-xs-1"></div>
                                <div class="col-xs-4">
                                    <p><a href="{{ path('actions' , {id: (account.tasks | last).id}  ) }}"><span class="glyphicon glyphicon-eye-open"/> Детали</a></p>
                                </div>
                            </div>

                            {% else %}
                                <h3>Ваша история заданий пуста =( </h3>
                            {% endif %}

                        </div>

                        <div class="tab-pane" id="history{{ account.id }}">
                            {% for task in account.tasks|reverse %}
                                <div class="row">
                                    <div class="col-xs-3">
                                        {% if task.type == 0 %}
                                        <p>Подписка по ID<p>
                                        {% elseif task.type == 10 %}
                                            <p>Подписка по тэгам</p>
                                        {% elseif task.type == 11 %}
                                            <p>Лайкинг по тэгам</p>
                                        {% elseif task.type == 3 %}
                                            <p>Отписка</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-xs-3 long_tags">
                                        {% if task.type in [0, 1] %}
                                            <p>{{ task.tags  }}</p>
                                        {% elseif task.type in [10, 11] %}
                                        <div class="comment more">{{ task.tags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-xs-1">
                                        <p>{{ task.count  }}</p>
                                    </div>
                                    <div class="col-xs-2">
                                        <p>{{ task.createdAt |date("h:i d/m/Y") }}</p>
                                    </div>
                                    <div class="col-xs-1">
                                        <p><a href="{{ path('actions' , {id: task.id}  ) }}"><span class="glyphicon glyphicon-eye-open"/></a></p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                    </div>

                </div>
                <!-- panel body end-->

            </div>
        </div>

    {% endfor %}
</div>


{% endblock %}
