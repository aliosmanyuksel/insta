{% extends 'base.html.twig' %}

{% block body %}
    <p id="error" hidden="hidden">Авторизация не удалась, Вы ввели неверные данные?</p>
    {{ form_start(form) }}
    {{ form_end(form) }}
    <button id='add_account' onclick="submitForm()" class="btn btn-primary" >Добавить</button>

    <script>
        function submitForm() {
            var result = null;
            postForm( function (response) {
                result = (response);
                console.log(result);
                if(result != 1)
                    $('#error').show();
                else{
                    $('form').hide();
                    $('#add_account').hide();
                    $('#error').hide();
                    $('.content').append('<p>Подождите...</p>');

                    postAuthForm($('form'),function (response2)
                    {
                        console.log(response2);

                        if(response2 !=1 )
                            $('.content').append('<p>Что то пошло не так, попробуйте еще раз.</p>');
                        else
                            window.location.replace("{{ path('accounts') }}");
                    });
                }
            });
        }

        function postAuthForm( $form,callback ){
            var values = {};
            $.each( $form.serializeArray(), function(i, field) {
                values[field.name] = field.value;
                console.log(field.value);
            });
            $.ajax({
                type        : 'post',
                url         : "{{  path('add_login_password_account')}}" ,
                data        : values,
                success     : function(data) {
                    callback( data );}
            });
        }

        function postForm( callback ){
            var login = $('#form_instLogin').val();
            var password = $('#form_instPass').val();
            var values = {login: login, password : password};

            $.ajax({
                type        : 'post',
                url         : "{{  path('check_login_password_account')}}" ,
                data        : values,
                success     : function(data) {
                    callback( data );}
            });
        }

    </script>
{% endblock %}
